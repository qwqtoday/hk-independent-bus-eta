function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/SharingModal-B1G1IyYL.js","assets/index-3ZrRw547.js","assets/index-BSkLjl09.css","assets/TimeReport-DXs2yIAD.js","assets/App-BbGSVcmn.js","assets/App-C05wK8aK.css","assets/CircularProgress-Rq-XzyyU.js","assets/Snackbar-CUVcwQrS.js","assets/RouteMap-BL_U6Zaa.js","assets/BaseTile-ClBzsxjd.js","assets/CompassControl-DEr3yhWd.js","assets/index-CSw0eUHx.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
import{m as G,I as K,J as N,f as W,r as i,L as Y,p as Z,q as M,j as o,h as q,l as Q,t as A,aB as Te,a3 as O,a4 as X,a8 as U,a5 as Ce,aC as De,aD as fe,ap as V,a7 as Ae,an as ce,ab as je,a9 as D,Z as J,aE as Ne,ad as pe,am as B,F as ue,ae as xe,ar as ye,g as Pe,aF as _e,aA as Oe,aG as Ee}from"./index-3ZrRw547.js";import{c as Le,d as me,e as Be,T as qe,a as he,f as Ue,I as P,P as Fe,R as He,D as Ve,B as We,g as Je,b as Ge,u as Ke}from"./App-BbGSVcmn.js";import{C as Ye,A as Ze,a as Qe,b as Xe,T as et}from"./TimeReport-DXs2yIAD.js";import{S as Ie}from"./Star-B7nAi-1O.js";import{I as tt,S as ot}from"./Share-DOp29bK0.js";import{S as nt}from"./StopRouteList-C8_SU5qR.js";import{D as st}from"./DialogTitle-hrBtx44P.js";import{C as rt}from"./Close-D-e4cEH7.js";import"./CircularProgress-Rq-XzyyU.js";function at(e){return G("MuiIcon",e)}K("MuiIcon",["root","colorPrimary","colorSecondary","colorAction","colorError","colorDisabled","fontSizeInherit","fontSizeSmall","fontSizeMedium","fontSizeLarge"]);const lt=["baseClassName","className","color","component","fontSize"],it=e=>{const{color:t,fontSize:n,classes:s}=e,r={root:["root",t!=="inherit"&&`color${W(t)}`,`fontSize${W(n)}`]};return Q(r,at,s)},ct=N("span",{name:"MuiIcon",slot:"Root",overridesResolver:(e,t)=>{const{ownerState:n}=e;return[t.root,n.color!=="inherit"&&t[`color${W(n.color)}`],t[`fontSize${W(n.fontSize)}`]]}})(({theme:e,ownerState:t})=>({userSelect:"none",width:"1em",height:"1em",overflow:"hidden",display:"inline-block",textAlign:"center",flexShrink:0,fontSize:{inherit:"inherit",small:e.typography.pxToRem(20),medium:e.typography.pxToRem(24),large:e.typography.pxToRem(36)}[t.fontSize],color:{primary:(e.vars||e).palette.primary.main,secondary:(e.vars||e).palette.secondary.main,info:(e.vars||e).palette.info.main,success:(e.vars||e).palette.success.main,warning:(e.vars||e).palette.warning.main,action:(e.vars||e).palette.action.active,error:(e.vars||e).palette.error.main,disabled:(e.vars||e).palette.action.disabled,inherit:void 0}[t.color]})),Me=i.forwardRef(function(t,n){const s=Y({props:t,name:"MuiIcon"}),{baseClassName:r="material-icons",className:l,color:a="inherit",component:p="span",fontSize:m="medium"}=s,x=Z(s,lt),c=M({},s,{baseClassName:r,color:a,component:p,fontSize:m}),d=it(c);return o.jsx(ct,M({as:p,className:q(r,"notranslate",d.root,l),ownerState:c,"aria-hidden":!0,ref:n},x))});Me.muiName="Icon";const be=Me,pt=i.createContext({}),ne=pt,ut=i.createContext({}),de=ut;function dt(e){return G("MuiStep",e)}K("MuiStep",["root","horizontal","vertical","alternativeLabel","completed"]);const ft=["active","children","className","component","completed","disabled","expanded","index","last"],xt=e=>{const{classes:t,orientation:n,alternativeLabel:s,completed:r}=e;return Q({root:["root",n,s&&"alternativeLabel",r&&"completed"]},dt,t)},mt=N("div",{name:"MuiStep",slot:"Root",overridesResolver:(e,t)=>{const{ownerState:n}=e;return[t.root,t[n.orientation],n.alternativeLabel&&t.alternativeLabel,n.completed&&t.completed]}})(({ownerState:e})=>M({},e.orientation==="horizontal"&&{paddingLeft:8,paddingRight:8},e.alternativeLabel&&{flex:1,position:"relative"})),ht=i.forwardRef(function(t,n){const s=Y({props:t,name:"MuiStep"}),{active:r,children:l,className:a,component:p="div",completed:m,disabled:x,expanded:c=!1,index:d,last:u}=s,f=Z(s,ft),{activeStep:h,connector:g,alternativeLabel:$,orientation:y,nonLinear:C}=i.useContext(ne);let[L=!1,j=!1,w=!1]=[r,m,x];h===d?L=r!==void 0?r:!0:!C&&h>d?j=m!==void 0?m:!0:!C&&h<d&&(w=x!==void 0?x:!0);const b=i.useMemo(()=>({index:d,last:u,expanded:c,icon:d+1,active:L,completed:j,disabled:w}),[d,u,c,L,j,w]),I=M({},s,{active:L,orientation:y,alternativeLabel:$,completed:j,disabled:w,expanded:c,component:p}),k=xt(I),v=o.jsxs(mt,M({as:p,className:q(k.root,a),ref:n,ownerState:I},f,{children:[g&&$&&d!==0?g:null,l]}));return o.jsx(de.Provider,{value:b,children:g&&!$&&d!==0?o.jsxs(i.Fragment,{children:[g,v]}):v})}),bt=ht,gt=A(o.jsx("path",{d:"M12 0a12 12 0 1 0 0 24 12 12 0 0 0 0-24zm-2 17l-5-5 1.4-1.4 3.6 3.6 7.6-7.6L19 8l-9 9z"}),"CheckCircle"),vt=A(o.jsx("path",{d:"M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"}),"Warning");function St(e){return G("MuiStepIcon",e)}const Ct=K("MuiStepIcon",["root","active","completed","error","text"]),le=Ct;var ge;const jt=["active","className","completed","error","icon"],yt=e=>{const{classes:t,active:n,completed:s,error:r}=e;return Q({root:["root",n&&"active",s&&"completed",r&&"error"],text:["text"]},St,t)},ie=N(Te,{name:"MuiStepIcon",slot:"Root",overridesResolver:(e,t)=>t.root})(({theme:e})=>({display:"block",transition:e.transitions.create("color",{duration:e.transitions.duration.shortest}),color:(e.vars||e).palette.text.disabled,[`&.${le.completed}`]:{color:(e.vars||e).palette.primary.main},[`&.${le.active}`]:{color:(e.vars||e).palette.primary.main},[`&.${le.error}`]:{color:(e.vars||e).palette.error.main}})),Lt=N("text",{name:"MuiStepIcon",slot:"Text",overridesResolver:(e,t)=>t.text})(({theme:e})=>({fill:(e.vars||e).palette.primary.contrastText,fontSize:e.typography.caption.fontSize,fontFamily:e.typography.fontFamily})),It=i.forwardRef(function(t,n){const s=Y({props:t,name:"MuiStepIcon"}),{active:r=!1,className:l,completed:a=!1,error:p=!1,icon:m}=s,x=Z(s,jt),c=M({},s,{active:r,completed:a,error:p}),d=yt(c);if(typeof m=="number"||typeof m=="string"){const u=q(l,d.root);return p?o.jsx(ie,M({as:vt,className:u,ref:n,ownerState:c},x)):a?o.jsx(ie,M({as:gt,className:u,ref:n,ownerState:c},x)):o.jsxs(ie,M({className:u,ref:n,ownerState:c},x,{children:[ge||(ge=o.jsx("circle",{cx:"12",cy:"12",r:"12"})),o.jsx(Lt,{className:d.text,x:"12",y:"12",textAnchor:"middle",dominantBaseline:"central",ownerState:c,children:m})]}))}return m}),Mt=It;function $t(e){return G("MuiStepLabel",e)}const kt=K("MuiStepLabel",["root","horizontal","vertical","label","active","completed","error","disabled","iconContainer","alternativeLabel","labelContainer"]),_=kt,Rt=["children","className","componentsProps","error","icon","optional","slotProps","StepIconComponent","StepIconProps"],wt=e=>{const{classes:t,orientation:n,active:s,completed:r,error:l,disabled:a,alternativeLabel:p}=e;return Q({root:["root",n,l&&"error",a&&"disabled",p&&"alternativeLabel"],label:["label",s&&"active",r&&"completed",l&&"error",a&&"disabled",p&&"alternativeLabel"],iconContainer:["iconContainer",s&&"active",r&&"completed",l&&"error",a&&"disabled",p&&"alternativeLabel"],labelContainer:["labelContainer",p&&"alternativeLabel"]},$t,t)},zt=N("span",{name:"MuiStepLabel",slot:"Root",overridesResolver:(e,t)=>{const{ownerState:n}=e;return[t.root,t[n.orientation]]}})(({ownerState:e})=>M({display:"flex",alignItems:"center",[`&.${_.alternativeLabel}`]:{flexDirection:"column"},[`&.${_.disabled}`]:{cursor:"default"}},e.orientation==="vertical"&&{textAlign:"left",padding:"8px 0"})),Tt=N("span",{name:"MuiStepLabel",slot:"Label",overridesResolver:(e,t)=>t.label})(({theme:e})=>M({},e.typography.body2,{display:"block",transition:e.transitions.create("color",{duration:e.transitions.duration.shortest}),[`&.${_.active}`]:{color:(e.vars||e).palette.text.primary,fontWeight:500},[`&.${_.completed}`]:{color:(e.vars||e).palette.text.primary,fontWeight:500},[`&.${_.alternativeLabel}`]:{marginTop:16},[`&.${_.error}`]:{color:(e.vars||e).palette.error.main}})),Dt=N("span",{name:"MuiStepLabel",slot:"IconContainer",overridesResolver:(e,t)=>t.iconContainer})(()=>({flexShrink:0,display:"flex",paddingRight:8,[`&.${_.alternativeLabel}`]:{paddingRight:0}})),At=N("span",{name:"MuiStepLabel",slot:"LabelContainer",overridesResolver:(e,t)=>t.labelContainer})(({theme:e})=>({width:"100%",color:(e.vars||e).palette.text.secondary,[`&.${_.alternativeLabel}`]:{textAlign:"center"}})),$e=i.forwardRef(function(t,n){var s;const r=Y({props:t,name:"MuiStepLabel"}),{children:l,className:a,componentsProps:p={},error:m=!1,icon:x,optional:c,slotProps:d={},StepIconComponent:u,StepIconProps:f}=r,h=Z(r,Rt),{alternativeLabel:g,orientation:$}=i.useContext(ne),{active:y,disabled:C,completed:L,icon:j}=i.useContext(de),w=x||j;let b=u;w&&!b&&(b=Mt);const I=M({},r,{active:y,alternativeLabel:g,completed:L,disabled:C,error:m,orientation:$}),k=wt(I),v=(s=d.label)!=null?s:p.label;return o.jsxs(zt,M({className:q(k.root,a),ref:n,ownerState:I},h,{children:[w||b?o.jsx(Dt,{className:k.iconContainer,ownerState:I,children:o.jsx(b,M({completed:L,active:y,error:m,icon:w},f))}):null,o.jsxs(At,{className:k.labelContainer,ownerState:I,children:[l?o.jsx(Tt,M({ownerState:I},v,{className:q(k.label,v==null?void 0:v.className),children:l})):null,c]})]}))});$e.muiName="StepLabel";const Nt=$e;function Pt(e){return G("MuiStepConnector",e)}K("MuiStepConnector",["root","horizontal","vertical","alternativeLabel","active","completed","disabled","line","lineHorizontal","lineVertical"]);const _t=["className"],Ot=e=>{const{classes:t,orientation:n,alternativeLabel:s,active:r,completed:l,disabled:a}=e,p={root:["root",n,s&&"alternativeLabel",r&&"active",l&&"completed",a&&"disabled"],line:["line",`line${W(n)}`]};return Q(p,Pt,t)},Et=N("div",{name:"MuiStepConnector",slot:"Root",overridesResolver:(e,t)=>{const{ownerState:n}=e;return[t.root,t[n.orientation],n.alternativeLabel&&t.alternativeLabel,n.completed&&t.completed]}})(({ownerState:e})=>M({flex:"1 1 auto"},e.orientation==="vertical"&&{marginLeft:12},e.alternativeLabel&&{position:"absolute",top:12,left:"calc(-50% + 20px)",right:"calc(50% + 20px)"})),Bt=N("span",{name:"MuiStepConnector",slot:"Line",overridesResolver:(e,t)=>{const{ownerState:n}=e;return[t.line,t[`line${W(n.orientation)}`]]}})(({ownerState:e,theme:t})=>{const n=t.palette.mode==="light"?t.palette.grey[400]:t.palette.grey[600];return M({display:"block",borderColor:t.vars?t.vars.palette.StepConnector.border:n},e.orientation==="horizontal"&&{borderTopStyle:"solid",borderTopWidth:1},e.orientation==="vertical"&&{borderLeftStyle:"solid",borderLeftWidth:1,minHeight:24})}),qt=i.forwardRef(function(t,n){const s=Y({props:t,name:"MuiStepConnector"}),{className:r}=s,l=Z(s,_t),{alternativeLabel:a,orientation:p="horizontal"}=i.useContext(ne),{active:m,disabled:x,completed:c}=i.useContext(de),d=M({},s,{alternativeLabel:a,orientation:p,active:m,completed:c,disabled:x}),u=Ot(d);return o.jsx(Et,M({className:q(u.root,r),ref:n,ownerState:d},l,{children:o.jsx(Bt,{className:u.line,ownerState:d})}))}),Ut=qt;function Ft(e){return G("MuiStepper",e)}K("MuiStepper",["root","horizontal","vertical","alternativeLabel"]);const Ht=["activeStep","alternativeLabel","children","className","component","connector","nonLinear","orientation"],Vt=e=>{const{orientation:t,alternativeLabel:n,classes:s}=e;return Q({root:["root",t,n&&"alternativeLabel"]},Ft,s)},Wt=N("div",{name:"MuiStepper",slot:"Root",overridesResolver:(e,t)=>{const{ownerState:n}=e;return[t.root,t[n.orientation],n.alternativeLabel&&t.alternativeLabel]}})(({ownerState:e})=>M({display:"flex"},e.orientation==="horizontal"&&{flexDirection:"row",alignItems:"center"},e.orientation==="vertical"&&{flexDirection:"column"},e.alternativeLabel&&{alignItems:"flex-start"})),Jt=o.jsx(Ut,{}),Gt=i.forwardRef(function(t,n){const s=Y({props:t,name:"MuiStepper"}),{activeStep:r=0,alternativeLabel:l=!1,children:a,className:p,component:m="div",connector:x=Jt,nonLinear:c=!1,orientation:d="horizontal"}=s,u=Z(s,Ht),f=M({},s,{alternativeLabel:l,orientation:d,component:m}),h=Vt(f),g=i.Children.toArray(a).filter(Boolean),$=g.map((C,L)=>i.cloneElement(C,M({index:L,last:L+1===g.length},C.props))),y=i.useMemo(()=>({activeStep:r,alternativeLabel:l,connector:x,nonLinear:c,orientation:d}),[r,l,x,c,d]);return o.jsx(ne.Provider,{value:y,children:o.jsx(Wt,M({as:m,ownerState:f,className:q(h.root,p),ref:n},u,{children:$}))})}),Kt=Gt,ve=A(o.jsx("path",{d:"M14.4 6 14 4H5v17h2v-7h5.6l.4 2h7V6z"}),"Flag"),Se=A(o.jsx("path",{d:"m12.36 6 .4 2H18v6h-3.36l-.4-2H7V6zM14 4H5v17h2v-7h5.6l.4 2h7V6h-5.6z"}),"FlagOutlined"),Yt=A(o.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2"}),"Lens"),Zt=A(o.jsx("path",{d:"m12 7.27 4.28 10.43-3.47-1.53-.81-.36-.81.36-3.47 1.53zM12 2 4.5 20.29l.71.71L12 18l6.79 3 .71-.71z"}),"NavigationOutlined"),Qt=A(o.jsx("path",{d:"M10 20h4c0 1.1-.9 2-2 2s-2-.9-2-2m4-11c0 2.61 1.67 4.83 4 5.66V17h2v2H4v-2h2v-7c0-2.79 1.91-5.14 4.5-5.8v-.7c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5v.7c.71.18 1.36.49 1.95.9C14.54 6.14 14 7.51 14 9m10-1h-3V5h-2v3h-3v2h3v3h2v-3h3z"}),"NotificationAdd"),Xt=A(o.jsx("path",{d:"M20 18.69 7.84 6.14 5.27 3.49 4 4.76l2.8 2.8v.01c-.52.99-.8 2.16-.8 3.42v5l-2 2v1h13.73l2 2L21 19.72zM12 22c1.11 0 2-.89 2-2h-4c0 1.11.89 2 2 2m6-7.32V11c0-3.08-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68c-.15.03-.29.08-.42.12-.1.03-.2.07-.3.11h-.01c-.01 0-.01 0-.02.01-.23.09-.46.2-.68.31 0 0-.01 0-.01.01z"}),"NotificationsOff"),eo=A([o.jsx("path",{d:"M12 4c1.93 0 5 1.4 5 5.15 0 2.16-1.72 4.67-5 7.32-3.28-2.65-5-5.17-5-7.32C7 5.4 10.07 4 12 4m0-2C8.73 2 5 4.46 5 9.15c0 3.12 2.33 6.41 7 9.85 4.67-3.44 7-6.73 7-9.85C19 4.46 15.27 2 12 2"},"0"),o.jsx("path",{d:"M12 7c-1.1 0-2 .9-2 2s.9 2 2 2a2 2 0 1 0 0-4M5 20h14v2H5z"},"1")],"PinDropOutlined"),to=A(o.jsx("path",{d:"m22 9.24-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28z"}),"StarBorder"),oo=A(o.jsx("path",{d:"m22 9.24-7.19-.62L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21 12 17.27 18.18 21l-1.63-7.03zM12 15.4l-3.76 2.27 1-4.28-3.32-2.88 4.38-.38L12 6.1l1.71 4.04 4.38.38-3.32 2.88 1 4.28z"}),"StarBorderOutlined"),no=A(o.jsx("path",{d:"m18 12 4-4-4-4v3H3v2h15zM6 12l-4 4 4 4v-3h15v-2H6z"}),"SyncAlt"),so=A(o.jsx("path",{d:"M2 12C2 6.48 6.48 2 12 2s10 4.48 10 10-4.48 10-10 10S2 17.52 2 12m10 6c3.31 0 6-2.69 6-6s-2.69-6-6-6-6 2.69-6 6 2.69 6 6 6"}),"TripOrigin"),E={};async function ro({route:e,stopList:t,startSeq:n,endSeq:s,batchSize:r=4,signal:l}){const a=Object.values(e.stops)[0];if(!["kmb","nlb","ctb","lrtfeeder","gmb"].includes(Object.keys(e.stops)[0]))throw new Error("Support vehicle transport only");if(n<0)throw new Error("startSeq should be ≥ 0");if(s>=a.length)throw new Error("endSeq should be < number of stops");if(n>=s)throw new Error("startSeq should be < endSeq");let p=Date.now(),m=0,x=[];for(let c=n;c<s;++c){if(x.push([`${a[c]}-${a[c+1]}`,JSON.stringify({start:{lat:t[a[c]].location.lat,long:t[a[c]].location.lng},end:{lat:t[a[c+1]].location.lat,long:t[a[c+1]].location.lng},departIn:Math.round(m/15)*15})]),x.length<r&&c!==s-1)continue;(await Promise.all(x.map(([u,f])=>u in E&&E[u].ts+15*60*1e3>=p?Promise.resolve(E[u].m):fetch("https://tdas-api.hkemobility.gov.hk/tdas/api/route",{method:"POST",headers:{"Content-Type":"application/json"},body:f,signal:l}).then(h=>h.json()).then(({eta:h,distM:g,jSpeed:$})=>{var y;const C=(y=/(\d+)公里\/小時/g.exec($))===null||y===void 0?void 0:y[1];if(C!=null&&!isNaN(parseInt(C,10)))return g/Math.min(parseInt(C,10),70)/1e3*60;console.warn("Unable to parse TDAS response for more precise journey time. Falling back.");const[L,j]=h.split(":").map(w=>parseInt(w,10));return L*60+j}).catch(()=>4).then(h=>(E[u]={m:h*1.1,ts:p},h*1.1))))).forEach(u=>{m+=u}),x.length=0}for(const c in E)E[c].ts+15*60*1e3<p&&delete E[c];return m}const ao=({routeId:e,stopId:t})=>{const{t:n}=O(),s=X(),{db:{routeList:r,holidays:l,stopList:a,serviceDayMap:p}}=i.useContext(U),{vibrateDuration:m}=i.useContext(Ce),{route:x,stops:c,co:d,gtfsId:u}=r[e],f=Le(),h=i.useMemo(()=>De(l,new Date),[l]),g=i.useMemo(()=>{const y=Object.entries(r).reduce((b,[I,k])=>{if(I===e)return b;const{co:v,route:T,gtfsId:F}=k;return d[0]==="gmb"&&u&&u!==F?b:T===x&&JSON.stringify(d)===JSON.stringify(v)?[...b,[I,k]]:b},[]).sort(([,b],[,I])=>{const k=fe(b.route,b.freq,h,p),v=fe(I.route,I.freq,h,p);if(k===v){const T=a[Object.values(c)[0][0]],F=a[Object.values(c)[0].slice(-1)[0]],se=a[Object.values(b.stops)[0][0]],re=a[Object.values(b.stops)[0].slice(-1)[0]],ae=V(se.location,F.location)+V(T.location,re.location),S=a[Object.values(I.stops)[0][0]],R=a[Object.values(I.stops)[0].slice(-1)[0]],z=V(S.location,F.location)+V(T.location,R.location);return ae<z?-1:1}return k>v?-1:1}).map(([b])=>b).filter(b=>b.toLowerCase()!==e);if(y.length===0)return null;const C=a[t].location;let L=Object.values(r[y[0]].stops)[0],j=-1,w=9999999;for(let b=0;b<L.length;++b){let I=V(C,a[L[b]].location);I<w&&(w=I,j=b)}return`/${s}/route/${y[0].toLowerCase()}/${L[j]}%2C${j}`},[x,d,u,r,a,h,e,c,p,s,t]),$=i.useCallback(y=>C=>{C.preventDefault(),y&&(Ae(m),f(y))},[f,m]);return g&&o.jsxs(o.Fragment,{children:[o.jsx(ce,{orientation:"vertical",sx:lo}),o.jsx(je,{variant:"text","aria-label":"open-timetable",sx:io,size:"small",startIcon:o.jsx(no,{}),onClick:$(g),children:n("對頭線")})]})},lo={position:"absolute",top:"0",left:"calc(64px + 2%)"},io={color:e=>e.palette.getContrastText(e.palette.background.default),position:"absolute",top:0,left:"2%",flexDirection:"column",justifyContent:"center","& > .MuiButton-label":{flexDirection:"column",justifyContent:"center"},"& > .MuiButton-startIcon":{margin:0}},co=({routeId:e})=>{const{db:{routeList:t,stopList:n}}=i.useContext(U),s=X(),r=t[e],{t:l}=O(),[a,p]=i.useState(uo),m=i.useRef(null);i.useEffect(()=>{var u;if(a.startSeq===null||a.endSeq===null){p(f=>({...f,jt:r.jt!==null?Math.round(parseFloat(r.jt)):null}));return}(u=m.current)==null||u.abort(),m.current=new AbortController,p(f=>({...f,isLoading:!0})),ro({route:r,startSeq:a.startSeq,endSeq:a.endSeq,stopList:n,batchSize:Math.max(Math.ceil((a.endSeq-a.startSeq)/3),6),signal:m.current.signal}).then(f=>{p(h=>({...h,jt:Math.round(f),isLoading:!1}))}).catch(f=>{console.error(f),p(h=>({...h,isLoading:!1}))})},[r,a.endSeq,a.startSeq,n]);const x=i.useMemo(()=>Object.values(r.stops)[0],[r]),c=i.useCallback(u=>()=>{p(f=>{let h=f.startSeq,g=f.endSeq,$=f.choice;return f.choice==="start"?(f.startSeq===u?h=null:h=u,g!==null&&u>=g&&(g=null),h!==null&&g===null&&($="end")):(f.endSeq===u?g=null:g=u,h!==null&&u<=h&&(h=null),g!==null&&h===null&&($="start")),{...f,startSeq:h,endSeq:g,choice:$}})},[]),d=i.useCallback(u=>()=>{p(f=>({...f,choice:u}))},[]);return o.jsxs(D,{display:"flex",flexDirection:"column",pt:1,flex:1,overflow:"hidden",children:[o.jsxs(D,{display:"flex",flexDirection:"column",gap:1,p:1,children:[o.jsxs(D,{display:"flex",gap:1,onClick:d("start"),children:[o.jsx(be,{color:a.choice==="start"?"primary":void 0,children:a.choice==="start"?o.jsx(ve,{}):o.jsx(Se,{})}),o.jsx(me,{variant:"standard",value:a.startSeq!==null?n[x[a.startSeq]].name[s]:"",fullWidth:!0,placeholder:l("起點"),focused:a.choice==="start",sx:{pointerEvents:"none"}})]}),o.jsxs(D,{display:"flex",gap:1,onClick:d("end"),children:[o.jsx(be,{color:a.choice==="end"?"primary":void 0,children:a.choice==="end"?o.jsx(ve,{}):o.jsx(Se,{})}),o.jsx(me,{variant:"standard",value:a.endSeq!==null?n[x[a.endSeq]].name[s]:"",fullWidth:!0,placeholder:l("目的地"),focused:a.choice==="end",sx:{pointerEvents:"none"}})]})]}),o.jsxs(D,{sx:fo,children:[o.jsx(J,{variant:"subtitle1",children:l("車程")}),o.jsx(J,{variant:"subtitle1",children:a.isLoading?o.jsx(Ye,{sx:{m:0},size:16}):`${a.jt??" - "} ${l("分鐘")}`})]}),o.jsx(ce,{sx:{my:2}}),o.jsx(D,{overflow:"auto",flex:1,children:o.jsx(Kt,{orientation:"vertical",children:x.map((u,f)=>o.jsx(bt,{active:xo(f,a.startSeq,a.endSeq),onClick:c(f),children:o.jsx(Nt,{StepIconComponent:po,children:n[u].name[s]})},u))})})]})},po=({active:e,completed:t})=>e||t?o.jsx(Yt,{}):o.jsx(so,{}),uo={startSeq:null,endSeq:null,jt:null,choice:"start",isLoading:!1},fo={display:"flex",justifyContent:"space-between",width:"80%"},xo=(e,t,n)=>t===e||n===e?!0:t!==null&&n!==null?t<e&&e<n:!1,mo=({routeId:e,open:t,onClose:n})=>{const{t:s}=O(),[r,l]=i.useState("jt"),a=i.useMemo(()=>({onClose:()=>{n()}}),[n]),p=i.useMemo(()=>({sx:ho}),[]);return o.jsxs(Be,{open:t,ModalProps:a,PaperProps:p,anchor:"right",children:[o.jsxs(qe,{value:r,onChange:(m,x)=>l(x),sx:bo,children:[o.jsx(he,{label:s("車程"),value:"jt"}),o.jsx(he,{value:"schedule",label:s("時間表")})]}),r==="jt"&&o.jsx(co,{routeId:e}),r==="schedule"&&o.jsx(Ne,{routeId:e})]})},ho={height:"100vh",width:"80%",maxWidth:"320px",paddingTop:"56px",paddingLeft:"20px",backgroundColor:e=>e.palette.background.default,backgroundImage:"none",overflow:"hidden"},bo={background:e=>e.palette.background.default,minHeight:"36px","& .MuiTab-root":{textTransform:"none",alignItems:"center",justifyContent:"center",paddingTop:0,paddingBottom:0,minHeight:"32px"},"& .MuiTabs-flexContainer":{justifyContent:"flex-start"}},go=({routeId:e})=>{const[t,n]=i.useState(!1),{t:s}=O();return o.jsxs(o.Fragment,{children:[o.jsx(ce,{orientation:"vertical",sx:vo}),o.jsx(je,{variant:"text","aria-label":"open-timetable",sx:So,size:"small",startIcon:o.jsx(Ue,{}),onClick:()=>n(!0),children:s("車程")}),o.jsx(mo,{routeId:e,open:t,onClose:()=>n(!1)})]})},vo={position:"absolute",top:"0",right:"calc(64px + 2%)"},So={color:e=>e.palette.getContrastText(e.palette.background.default),flexDirection:"column",justifyContent:"center","& > .MuiButton-label":{flexDirection:"column",justifyContent:"center"},"& > .MuiButton-startIcon":{margin:0}},Co=({routeId:e})=>{const{savedEtas:t,setCollectionDrawerRoute:n}=i.useContext(pe);return o.jsx(P,{sx:jo,size:"small",onClick:()=>{const s=`${e.toUpperCase()}`;n(s)},children:t.includes(e)?o.jsx(Ie,{}):o.jsx(oo,{})})},jo={color:e=>e.palette.getContrastText(e.palette.background.default),flexDirection:"column",justifyContent:"center","& > .MuiButton-label":{flexDirection:"column",justifyContent:"center"},"& > .MuiButton-startIcon":{margin:0}},yo=({routeId:e,stopId:t})=>{const{t:n}=O(),s=X(),{db:{routeList:r}}=i.useContext(U),{route:l,orig:a,dest:p,nlbId:m}=r[e];return o.jsxs(Fe,{id:"route-eta-header",sx:Lo,elevation:0,children:[o.jsx(He,{routeNo:n(l),component:"h1",align:"center"}),o.jsxs(J,{component:"h2",variant:"caption",align:"center",children:[n("往")," ",B(p[s])," ",m?n("由")+" "+B(a[s]):""]}),o.jsx(ao,{routeId:e,stopId:t}),o.jsxs(D,{sx:Io,children:[o.jsx(Co,{routeId:e}),o.jsx(go,{routeId:e})]})]})},Lo={textAlign:"center",background:"transparent",position:"relative"},Io={position:"absolute",top:0,right:"2%"},Mo=ue.forwardRef((e,t)=>{const{routeId:n,stopId:s,stopIdx:r,idx:l,onShareClick:a,onSummaryClick:p,onStopInfoClick:m}=e,{db:{routeList:x,stopList:c}}=i.useContext(U),{savedEtas:d,setCollectionDrawerRoute:u,collections:f}=i.useContext(pe),{alarmStopId:h,toggleStopAlarm:g}=i.useContext(xe),{isStopAlarm:$}=i.useContext(xe),{t:y}=O(),C=X(),{fares:L,faresHoliday:j}=x[n],w=c[s],b=i.useMemo(()=>d.includes(`${n.toUpperCase()}/${l}`)||f.reduce((v,T)=>v||T.list.includes(`${n.toUpperCase()}/${l}`),!1),[d,f,n,l]),I=i.useCallback(v=>{a({routeId:n,seq:l,stopId:s,event:v})},[a,n,l,s]),k=i.useCallback((v,T)=>{p(l,T)},[l,p]);return o.jsxs(Ze,{id:`stop-${l}`,expanded:r===l&&navigator.userAgent!=="prerendering",onChange:k,TransitionProps:{unmountOnExit:!0},ref:t,sx:$o,children:[o.jsxs(Qe,{sx:ko,children:[o.jsxs(J,{component:"h3",variant:"body1",sx:{fontWeight:700},children:[l+1,". ",B(w.name[C])]}),o.jsxs(J,{variant:"body2",children:[L&&L[l]?y("車費")+": $"+L[l]:"",j&&j[l]?"　　　　"+y("假日車費")+": $"+j[l]:""]})]}),o.jsxs(Xe,{sx:Ro,children:[o.jsx(et,{containerSx:wo,routeId:`${n.toUpperCase()}`,seq:l}),o.jsxs(D,{display:"flex",flexDirection:"column",alignItems:"flex-end",children:[o.jsxs(D,{children:[$&&o.jsx(P,{"aria-label":"alert",onClick:()=>g(s),style:{backgroundColor:"transparent"},size:"large",children:h===s?o.jsx(Xt,{}):o.jsx(Qt,{})}),o.jsx(P,{"aria-label":"stop-info",onClick:m,style:{background:"transparent"},size:"large",children:o.jsx(tt,{})})]}),o.jsxs(D,{children:[o.jsx(P,{"aria-label":"share",onClick:I,style:{backgroundColor:"transparent"},size:"large",children:o.jsx(ot,{})}),o.jsx(P,{"aria-label":"favourite",onClick:()=>{const v=`${n.toUpperCase()}/${l}`;u(v)},style:{backgroundColor:"transparent"},size:"large",children:b?o.jsx(Ie,{sx:zo}):o.jsx(to,{})})]})]})]})]})}),$o={border:"1px solid rgba(0, 0, 0, .125)",boxShadow:"none","&:not(:last-child)":{borderBottom:0},"&:before":{display:"none"},"&.Mui-expanded":{margin:"auto"}},ko={backgroundColor:e=>e.palette.mode==="dark"?e.palette.background.default:"rgba(0, 0, 0, .03)","&.Mui-expanded":{borderBottom:"1px solid rgba(0, 0, 0, .125)",minHeight:44},minHeight:44,"& .MuiAccordionSummary-content":{margin:"8px 0",flexDirection:"column","&.Mui-expanded":{margin:"8px 0"}}},Ro={display:"flex",alignItems:"center",pl:2,pr:1,py:1,justifyContent:"space-between"},wo={flex:1},zo={color:e=>e.palette.mode==="dark"?e.palette.primary.main:"inherit"},To=ue.lazy(()=>ye(()=>import("./SharingModal-B1G1IyYL.js"),__vite__mapDeps([0,1,2,3,4,5,6,7]))),Do=({routeId:e,stopIdx:t,stopIds:n,handleChange:s,onStopInfo:r})=>{const[l,a]=i.useState(null),p=i.useRef([]);i.useEffect(()=>{if(p.current[t]){const x=setTimeout(()=>{var c;(c=p.current[t])==null||c.scrollIntoView({behavior:"smooth",block:"center"})},50);return()=>{clearTimeout(x)}}},[t]);const m=i.useCallback(x=>c=>{p.current[x]=c},[]);return o.jsxs(D,{sx:Ao,children:[n.map((x,c)=>o.jsx(Mo,{routeId:e,stopId:x,stopIdx:t,idx:c,onShareClick:d=>a(d),onSummaryClick:s,onStopInfoClick:r,ref:m(c)},"stop-"+c)),l&&o.jsx(i.Suspense,{fallback:o.jsx(o.Fragment,{}),children:o.jsx(To,{...l})})]})},Ao={overflowY:"scroll"},No=({open:e,stops:t,onClose:n})=>{var c;const{db:{stopList:s}}=i.useContext(U),{savedStops:r,updateSavedStops:l}=i.useContext(pe),a=X(),p=i.useMemo(()=>t.reduce((d,u)=>d||r.includes(u.join("|")),!1),[t,r]),m=i.useCallback(()=>{var d;if((d=s[t[0][1]])!=null&&d.location){const{lat:u,lng:f}=s[t[0][1]].location;window.open(`https://www.google.com/maps/dir/?api=1&destination=${u},${f}&travelmode=walking`,"_blank")}},[s,t]),x=i.useCallback(()=>{var d;if((d=s[t[0][1]])!=null&&d.location){const{lat:u,lng:f}=s[t[0][1]].location;window.open(`https://www.google.com/maps/?q=${u},${f}`,"_blank")}},[s,t]);return o.jsxs(Ve,{open:e,onClose:n,sx:Po,children:[o.jsxs(st,{sx:_o,children:[o.jsxs(D,{children:[o.jsx(P,{onClick:()=>l(t[0].join("|")),children:p?o.jsx(We,{}):o.jsx(Je,{})}),(c=s[t[0][1]])==null?void 0:c.name[a],"  ",o.jsx(P,{onClick:m,children:o.jsx(Zt,{})}),o.jsx(P,{onClick:x,children:o.jsx(eo,{})})]}),o.jsx(D,{children:o.jsx(P,{onClick:n,children:o.jsx(rt,{})})})]}),o.jsx(Ge,{children:o.jsx(nt,{stops:t,isFocus:!0})})]})},Po={"& .MuiPaper-root":{width:"100%",marginTop:"90px",height:"calc(100vh - 100px)"},"& .MuiDialogContent-root":{padding:0}},_o={backgroundColor:e=>e.palette.background.default,color:e=>e.palette.primary.main,display:"flex",justifyContent:"space-between"};var Oo={compareTwoStrings:ke,findBestMatch:Eo};function ke(e,t){if(e=e.replace(/\s+/g,""),t=t.replace(/\s+/g,""),e===t)return 1;if(e.length<2||t.length<2)return 0;let n=new Map;for(let r=0;r<e.length-1;r++){const l=e.substring(r,r+2),a=n.has(l)?n.get(l)+1:1;n.set(l,a)}let s=0;for(let r=0;r<t.length-1;r++){const l=t.substring(r,r+2),a=n.has(l)?n.get(l):0;a>0&&(n.set(l,a-1),s++)}return 2*s/(e.length+t.length-2)}function Eo(e,t){if(!Bo(e,t))throw new Error("Bad arguments: First argument should be a string, second should be an array of strings");const n=[];let s=0;for(let l=0;l<t.length;l++){const a=t[l],p=ke(e,a);n.push({target:a,rating:p}),p>n[s].rating&&(s=l)}const r=n[s];return{ratings:n,bestMatch:r,bestMatchIndex:s}}function Bo(e,t){return!(typeof e!="string"||!Array.isArray(t)||!t.length||t.find(function(n){return typeof n!="string"}))}const qo=Pe(Oo),Uo=({route:e})=>{const[t,n]=i.useState(!1),{db:{updateTime:s},renewDb:r}=i.useContext(U),{t:l}=O();return i.useEffect(()=>{_e(e).then(a=>n(a>s))},[e,s]),t?o.jsx(D,{sx:Fo,onClick:r,children:o.jsx(J,{children:l("db-renew-text")})}):null},Fo={display:"flex",justifyContent:"center",flex:1,width:"100%",p:2,my:1,borderStyle:"solid",borderWidth:1,borderRadius:e=>e.shape.borderRadius/2,cursor:"pointer"},Ho=ue.lazy(()=>ye(()=>import("./RouteMap-BL_U6Zaa.js"),__vite__mapDeps([8,1,2,9,4,5,10,11]))),nn=()=>{const{id:e,panel:t}=Ke(),{AppTitle:n,db:{routeList:s,stopList:r,stopMap:l}}=i.useContext(U),{updateSelectedRoute:a,energyMode:p,geoPermission:m,geolocation:x}=i.useContext(Ce),c=Vo(e.toUpperCase(),s),d=s[c],{route:u,stops:f,co:h,orig:g,dest:$,fares:y}=d,C=i.useMemo(()=>Wo(h,f).map(S=>[S,r[S]]).filter(([,S])=>S!=null).map(([S])=>S),[h,r,f]),L=i.useMemo(()=>{if(m==="granted"){const S=C.map((R,z)=>[z,V(x.current,r[R].location)]).sort((R,z)=>R[1]-z[1])[0];if(S.length>0)return S[0]}return 0},[m,x,r,C]),j=i.useMemo(()=>{if(t!==void 0){const[S,R]=t.split(",");if(S===void 0||R===void 0)return parseInt(t,10);{const z=parseInt(R,10);let ee=0,te=9999999;for(let Re in f){let we=f[Re].reduce((H,oe,ze)=>(oe===S&&H.push(ze),H),[]);for(let H of we)if(H>=0){let oe=Math.abs(H-z);oe<te&&(ee=H,te=oe)}}return ee}}return L},[t,f,L]),[w,b]=i.useState(!1),I=i.useMemo(()=>Jo(h,f,l,j),[h,j,l,f]),{t:k}=O(),v=X(),T=Le(),F=i.useCallback((S,R)=>{if(R&&j!==S){let z=f[Object.keys(f).sort()[0]][S];T(`/${v}/route/${e}/${z}%2C${S}`,{replace:!0})}j===S&&!R&&b(!0)},[T,v,e,j,f]),se=i.useCallback(S=>{j===S&&b(!0),T(`/${v}/route/${e}/${S}`,{replace:!0})},[T,v,e,j]),re=i.useCallback(()=>{b(!0)},[b]),ae=i.useCallback(()=>{b(!1)},[b]);return i.useEffect(()=>{var S;return b(!1),(S=document.getElementById("render"))==null||S.setAttribute("value","done"),a(e),()=>{var R;(R=document.getElementById("render"))==null||R.setAttribute("value","")}},[e,a]),i.useEffect(()=>{e.toUpperCase()!==c.toUpperCase()&&T(`/${v}/route/${c.toLowerCase()}`)},[e,c,v,T]),i.useEffect(()=>{const S=()=>{const R=y?y.filter((z,ee,te)=>te.indexOf(z)===ee).map(z=>`$${z}`):[];return v==="zh"?`路線${u}由${g.zh}出發，以${$.zh}為終點，`+(R.length?`分段車費為${R.join("、")}，`:"")+`途經${C.map(z=>r[z].name.zh).join("、")}。`:`Route ${u} is from ${B(g.en)} to ${B($.en)}`+(R.length?`, section fees are ${R.join(", ")}. `:". ")+"Stops: "+B(C.map(z=>r[z].name.en).join(", "))+". "};Oe({title:u+" "+k("往")+" "+B($[v])+" - "+k(n),description:S(),lang:v}),Ee({route:d,stopList:r,t:k,lang:v})},[n,$,y,v,g.en,g.zh,u,r,C,k,d]),o.jsxs(o.Fragment,{children:[o.jsx("input",{hidden:!0,id:"render"}),o.jsx(yo,{routeId:c,stopId:C[j]}),o.jsx(Uo,{route:d}),!p&&navigator.userAgent!=="prerendering"&&o.jsx(i.Suspense,{fallback:null,children:o.jsx(Ho,{routeId:c,stopIds:C,stopIdx:j,route:u,companies:h,onMarkerClick:se})}),o.jsx(Do,{routeId:c,stopIdx:j,routeListEntry:d,stopIds:C,handleChange:F,onStopInfo:re}),o.jsx(No,{open:w,stops:I,onClose:ae})]})},Vo=(e,t)=>{if(t[e]!==void 0)return e;const n=e.split("-")[0];return qo.findBestMatch(e.toUpperCase(),Object.keys(t).filter(s=>s.startsWith(n))).bestMatch.target},Wo=(e,t)=>{for(let n=0;n<e.length;++n)if(e[n]in t)return t[e[n]];return[]},Jo=(e,t,n,s)=>{for(let r=0;r<e.length;++r)if(e[r]in t)return[[e[r],t[e[r]][s]]].concat(n[t[e[r]][s]]??[]);return[]};export{nn as default};
